<!DOCTYPE html>
<html>
    <head>
        <title>第15回課題: 防災・地震情報マップ</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
        <style>
            body { margin: 0; padding: 0; }
            #map { width: 100%; height: 100vh; }
            .legend { 
                background: white; 
                padding: 10px; 
                border-radius: 5px; 
                box-shadow: 0 0 15px rgba(0,0,0,0.2); 
            }
        </style>
    </head>
    <body>
        <div id="map"></div>
        <script>
            // ---------------------------------------------------------
            // 1. 地図の初期化（大阪周辺を初期位置に）
            // ---------------------------------------------------------
            const map = L.map('map', {
                center: [34.6937, 135.5023], // 大阪市中心部付近
                zoom: 11
            });

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // ---------------------------------------------------------
            // 2. 自分の地域の学校データ（P29-21_27.geojson）の読み込み
            // ---------------------------------------------------------
            fetch('P29-21_27.geojson')
                .then(res => res.json())
                .then(data => {
                    L.geoJson(data, {
                        pointToLayer: function (feature, latlng) {
                            // 学校は青いマーカーで表示
                            return L.marker(latlng);
                        },
                        onEachFeature: function (feature, layer) {
                            // ポップアップに学校名を表示
                            if (feature.properties && feature.properties.P29_004) {
                                layer.bindPopup("<b>学校:</b> " + feature.properties.P29_004);
                            }
                        }
                    }).addTo(map);
                })
                .catch(err => console.error("学校データの読み込みエラー:", err));

            // ---------------------------------------------------------
            // 3. 【追加要件】地域の他のデータ（避難所・経路情報）
            // ※外部ファイルを使わず、コードで直接記述して「ラインデータ」と「ポイントデータ」を追加
            // ---------------------------------------------------------
            
            // A. 避難経路のラインデータ（例：主要道路を通る避難ルートを想定）
            const routeCoordinates = [
                [34.6937, 135.5023], // 起点
                [34.6900, 135.5000],
                [34.6850, 135.5050],
                [34.6813, 135.5090]  // 終点（避難所）
            ];
            
            const evacuationRoute = L.polyline(routeCoordinates, {
                color: 'red',   // 赤色
                weight: 5,      // 太さ
                opacity: 0.7,
                dashArray: '10, 10' // 点線にする
            }).addTo(map);
            evacuationRoute.bindPopup("想定避難経路（ラインデータ）");

            // B. 避難所のポイントデータ（例：中之島公園）
            const shelterPoint = [34.6913, 135.5090];
            L.circleMarker(shelterPoint, {
                radius: 10,
                color: 'green',
                fillColor: '#0f0',
                fillOpacity: 0.5
            }).addTo(map).bindPopup("<b>広域避難場所</b><br>中之島公園（ポイントデータ）");


            // ---------------------------------------------------------
            // 4. APIによる地震情報の可視化
            // ---------------------------------------------------------
            
            // 震源地アイコンの設定
            const shingenIcon = L.icon({
                iconUrl: 'shingen.png', // アップロードされている画像
                iconSize: [32, 32],
                iconAnchor: [16, 16],
                popupAnchor: [0, -10]
            });

            fetch('https://api.p2pquake.net/v2/history?codes=551&limit=20')
                .then(res => res.json())
                .then(data => {
                    data.forEach(report => {
                        const earthquake = report.earthquake;
                        const hypocenter = earthquake.hypocenter;

                        // 座標が無効な場合はスキップ
                        if (hypocenter.latitude === -1 || hypocenter.longitude === -1) return;

                        const popupContent = `
                            <b>震源地: ${hypocenter.name}</b><br>
                            発生時刻: ${earthquake.time}<br>
                            M: ${hypocenter.magnitude.toFixed(1)} / 最大震度: ${earthquake.maxScale / 10}
                        `;

                        L.marker([hypocenter.latitude, hypocenter.longitude], { icon: shingenIcon })
                            .addTo(map)
                            .bindPopup(popupContent);
                    });
                })
                .catch(err => console.error("地震情報の取得エラー:", err));

        </script>
    </body>
</html>
